<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitty AI - Direct Core</title>
    <style>
        /* --- GIAO DI·ªÜN C≈® (GI·ªÆ NGUY√äN) --- */
        :root {
            --primary: #ff9f43; --bg-color: #fff0e6; --text-color: #333;
            --chat-user: #ff9f43; --chat-ai: #ffffff;
        }
        body.theme-sad { --primary: #74b9ff; --bg-color: #f1f7ff; --chat-user: #74b9ff; }
        body.theme-stress { --primary: #ff7675; --bg-color: #fff0f0; --chat-user: #ff7675; }
        body.theme-happy { --primary: #00b894; --bg-color: #e6fffa; --chat-user: #00b894; }
        body.theme-anxious { --primary: #a29bfe; --bg-color: #f8f0ff; --chat-user: #a29bfe; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; transition: all 0.5s ease; }
        body { background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        /* INTRO */
        #introScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 200; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .intro-card { background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 400px; border-top: 5px solid var(--primary); text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
        .intro-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; outline: none; }
        .start-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        /* APP */
        .app-container { width: 100%; max-width: 450px; height: 95vh; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; overflow: hidden; border: 2px solid var(--primary); opacity: 0; transform: scale(0.9); }
        .app-container.active { opacity: 1; transform: scale(1); }

        /* HEADER */
        .header { padding: 15px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; z-index: 10; }
        .avatar-wrapper { width: 45px; height: 45px; }
        .kitty-svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        body.theme-stress .kitty-svg { animation: shake 0.5s infinite; }
        body.theme-happy .kitty-svg { animation: bounce 1s infinite; }

        /* CHAT */
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; animation: fadeUp 0.3s ease; }
        .msg.ai { align-self: flex-start; background: var(--chat-ai); color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }
        
        /* TYPING */
        .typing { display: flex; gap: 5px; padding: 10px; background: white; width: fit-content; border-radius: 15px; margin-left: 10px; display: none; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: blink 1.4s infinite both; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }

        /* INPUT */
        .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 25px; outline: none; }
        button.send-btn { padding: 12px 20px; background: var(--primary); border: none; border-radius: 25px; color: white; cursor: pointer; }

        /* TOOLS */
        .tools-bar { display: flex; justify-content: space-around; padding: 10px; background: #fafafa; border-top: 1px solid #eee; }
        .tool-btn { font-size: 0.7rem; background: none; color: #666; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .tool-btn i { font-size: 1.1rem; }
        
        /* RESET & MODALS */
        .float-reset { position: absolute; bottom: 140px; right: 15px; width: 45px; height: 45px; background: white; border: 2px solid var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 50; transition: 0.3s; }
        .float-reset:hover { transform: rotate(180deg); }

        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; transform: translateY(100%); transition: 0.4s; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        .modal.active { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: var(--primary); }
        .close-btn { cursor: pointer; background: none; border: none; font-size: 1.5rem; }

        .therapy-item { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .therapy-btn-mini { background: var(--primary); color: white; border: none; padding: 5px 15px; border-radius: 15px; margin-top: 5px; cursor: pointer; font-size: 0.8rem; }

        #resetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a8e6cf, #dcedc1); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: #2d3436; }
        .reset-circle { width: 160px; height: 160px; border: 5px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; color: white; animation: breathe 8s infinite; }
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .dot { width: 35px; height: 35px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 0.6rem; color: white; font-weight: bold; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div id="introScreen">
        <div class="intro-card">
            <h1 style="color:var(--primary)">Kitty AI üéß</h1>
            <p>Tr·ª£ l√Ω T√¢m l√Ω & Gi·∫£i Tr√≠</p>
            <input type="text" id="inputName" class="intro-input" placeholder="T√™n c·ªßa b·∫°n..." required>
            <input type="text" id="inputClass" class="intro-input" placeholder="L·ªõp...">
            <select id="inputGender" class="intro-input">
                <option value="" disabled selected>-- Gi·ªõi t√≠nh --</option>
                <option value="Nam">Nam</option>
                <option value="N·ªØ">N·ªØ</option>
            </select>
            <button class="start-btn" onclick="startApp()">B·∫Øt ƒë·∫ßu</button>
        </div>
    </div>

    <div class="app-container" id="mainApp" style="display:none">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="avatar-wrapper">
                    <svg class="kitty-svg" viewBox="0 0 512 512">
                        <path fill="#fff" d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0z"/>
                        <path fill="#333" d="M368 152a24 24 0 1 1 0 48 24 24 0 1 1 0-48zM144 152a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/>
                        <path fill="#e55039" d="M256 270c-10 0-18 5-18 12s8 12 18 12s18-5 18-12s-8-12-18-12z"/>
                        <path fill="#ff9f43" d="M376.6 96c-13.7-13.7-32-21.4-51.7-21.4H187.1c-19.7 0-38 7.7-51.7 21.4C122.1 110.1 114.6 128.4 114.6 148.1V176c0 8.8 7.2 16 16 16h256c8.8 0 16-7.2 16-16v-27.9c0-19.7-7.5-38-21.4-51.7z"/>
                    </svg>
                </div>
                <div>
                    <div style="font-weight: bold;">Kitty AI</div>
                    <div style="font-size: 0.7rem; opacity: 0.9;" id="statusText">Tr·ª£ l√Ω c·ªßa b·∫°n</div>
                </div>
            </div>
            <div class="mhi-score"><span id="mhiScore">75</span>/100</div>
        </div>

        <div class="chat-area" id="chatBox"></div>
        
        <div class="typing" id="typingIndicator">
            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
        </div>

        <div class="float-reset" onclick="activateReset()" title="Reset T√¢m Tr√≠"><i class="fas fa-redo"></i></div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Nh·∫Øn tin v·ªõi AI..." autocomplete="off">
            <button class="send-btn" onclick="handleChat()">G·ª≠i</button>
        </div>

        <div class="tools-bar">
            <button class="tool-btn" onclick="toggleModal('statsModal')"><i class="fas fa-chart-line"></i> Th·ªëng k√™</button>
            <button class="tool-btn" onclick="toggleModal('therapyModal')"><i class="fas fa-heartbeat"></i> Tr·ªã li·ªáu</button>
            <button class="tool-btn" onclick="toggleModal('mapModal')"><i class="fas fa-users"></i> L·ªõp h·ªçc</button>
        </div>

        <div class="modal" id="statsModal">
            <div class="modal-header"><span>üìÖ Nh·∫≠t K√Ω C·∫£m X√∫c</span><button class="close-btn" onclick="toggleModal('statsModal')">√ó</button></div>
            <div id="timelineContent"></div>
        </div>

        <div class="modal" id="mapModal">
            <div class="modal-header"><span>üó∫Ô∏è B·∫£n ƒê·ªì L·ªõp <span id="classTitle"></span></span><button class="close-btn" onclick="toggleModal('mapModal')">√ó</button></div>
            <div class="map-grid" id="classMapGrid"></div>
        </div>

        <div class="modal" id="therapyModal">
            <div class="modal-header"><span>üíä G√≥c Tr·ªã Li·ªáu Mini</span><button class="close-btn" onclick="toggleModal('therapyModal')">√ó</button></div>
            <div class="therapy-item"><b><i class="fas fa-wind"></i> H√≠t th·ªü 4-7-8</b><button class="therapy-btn-mini" onclick="startExercise('breath')">T·∫≠p ngay</button></div>
            <div class="therapy-item"><b><i class="fas fa-child"></i> Du·ªói c·ªï vai</b><button class="therapy-btn-mini" onclick="startExercise('stretch')">T·∫≠p ngay</button></div>
            <div class="therapy-item"><b><i class="fas fa-hand-holding"></i> Grounding 5-4-3-2-1</b><button class="therapy-btn-mini" onclick="startExercise('grounding')">T·∫≠p ngay</button></div>
        </div>

        <div id="resetOverlay">
            <h2>Th∆∞ gi√£n s√¢u...</h2>
            <div class="reset-circle" id="resetCount">30</div>
            <p>ƒêang ph√°t ti·∫øng ·ªìn tr·∫Øng</p>
            <button onclick="closeReset()" style="margin-top:30px; padding:10px 30px; border-radius:20px; border:none; font-weight:bold;">ƒê√£ ·ªïn h∆°n</button>
        </div>
    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è D√ÅN API KEY V√ÄO GI·ªÆA HAI D·∫§U NGO·∫∂C K√âP B√äN D∆Ø·ªöI ‚ö†Ô∏è
        const API_KEY = "AIzaSyArF1xe-Gjy8dtjjXV7pWQuetBuxRq5EIE"; 
        // ============================================================

        let chatHistory = []; // L∆∞u l·ªãch s·ª≠ chat ƒë·ªÉ g·ª≠i cho Google (Tr√≠ nh·ªõ AI)
        let mhiScore = 75;
        let emotionLog = JSON.parse(localStorage.getItem('emotionHistory')) || [];
        let audioCtx, whiteNoiseSource;

        // 1. KH·ªûI T·∫†O
        async function startApp() {
            const name = document.getElementById('inputName').value.trim();
            const gender = document.getElementById('inputGender').value;
            const className = document.getElementById('inputClass').value.trim();

            if(!name || !gender) return alert("Nh·∫≠p thi·∫øu th√¥ng tin!");
            if(!API_KEY || API_KEY.includes("D√ÅN_M√É_KEY")) return alert("L·ªñI: Ch∆∞a d√°n API Key v√†o code!");

            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('classTitle').innerText = className || "";
            renderClassMap();

            // C√†i ƒë·∫∑t "nh√¢n c√°ch" cho AI
            const systemPrompt = `B·∫°n l√† Kitty AI, chuy√™n gia t√¢m l√Ω h·ªçc ƒë∆∞·ªùng. User: ${name}, ${gender}.
            Quy t·∫Øc: Th√¢n thi·ªán, d√πng 'm√¨nh-c·∫≠u'. N·∫øu user bu·ªìn, h√£y an ·ªßi v√† h·ªèi 'C·∫≠u c√≥ mu·ªën nghe nh·∫°c Lofi kh√¥ng?'. 
            N·∫øu user ƒë·ªìng √Ω nghe nh·∫°c, CH·ªà TR·∫¢ L·ªúI DUY NH·∫§T: 'PLAY_SPOTIFY_NOW'. 
            N·∫øu user t·ª´ ch·ªëi, h√£y ƒë·ªïi ch·ªß ƒë·ªÅ. Kh√¥ng n√≥i d√†i d√≤ng.`;

            chatHistory.push({ role: "user", parts: [{ text: systemPrompt }] });
            chatHistory.push({ role: "model", parts: [{ text: `Ch√†o ${name}! M√¨nh l√† Kitty AI. H√¥m nay c·∫≠u th·∫•y th·∫ø n√†o?` }] });

            addMessage(`Ch√†o <b>${name}</b>! M√¨nh l√† Kitty AI. H√¥m nay c·∫≠u th·∫•y th·∫ø n√†o? üò∫`, 'ai');
            document.getElementById('statusText').innerText = "AI Online ‚ö°";
        }

        // 2. X·ª¨ L√ù CHAT (G·ªåI API TR·ª∞C TI·∫æP - KH√îNG QUA TH∆Ø VI·ªÜN)
        async function handleChat() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, 'user');
            input.value = '';
            document.getElementById('typingIndicator').style.display = 'flex';
            
            chatHistory.push({ role: "user", parts: [{ text: text }] });

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ contents: chatHistory })
                });

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                document.getElementById('typingIndicator').style.display = 'none';
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });

                // X·ª≠ l√Ω m·∫≠t m√£ nh·∫°c
                if (aiText.includes("PLAY_SPOTIFY_NOW")) {
                    addMessage("Oki! B·∫≠t nh·∫°c chill ngay ƒë√¢y. üé∂", 'ai');
                    addMessage(`<iframe style="border-radius:12px; margin-top:10px;" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcBWIGoYBM5M?utm_source=generator" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`, 'ai');
                } else {
                    addMessage(aiText.replace(/\*\*/g, ''), 'ai');
                }

                updateUI(aiText);
                saveLog(text, aiText);

            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage("‚ö†Ô∏è L·ªói k·∫øt n·ªëi AI. Ki·ªÉm tra m·∫°ng ho·∫∑c API Key.", 'ai');
                console.error(error);
            }
        }

        // 3. C√ÅC T√çNH NƒÇNG PH·ª§ TR·ª¢
        function updateUI(text) {
            const t = text.toLowerCase();
            let mood = 'neutral';
            if(t.includes('bu·ªìn')||t.includes('kh√≥c')) mood='sad';
            else if(t.includes('vui')||t.includes('tuy·ªát')) mood='happy';
            else if(t.includes('cƒÉng')||t.includes('lo')) mood='stress';
            
            if(mood!=='neutral') {
                document.body.className=''; document.body.classList.add(`theme-${mood}`);
                let dot = document.getElementById('myMapDot'); if(dot) dot.style.background = (mood==='sad'?'#74b9ff':(mood==='stress'?'#ff7675':'#00b894'));
                updateMHI(mood==='happy'?5:-5);
            }
        }

        function updateMHI(val) {
            mhiScore = Math.min(Math.max(mhiScore + val, 0), 100);
            document.getElementById('mhiScore').innerText = mhiScore;
        }

        function saveLog(u, a) {
            emotionLog.unshift({ time: new Date().toLocaleTimeString(), user: u, ai: a });
            localStorage.setItem('emotionHistory', JSON.stringify(emotionLog));
        }

        // White Noise
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        function playWhiteNoise() {
            initAudio();
            const b = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
            const d = b.getChannelData(0); for(let i=0; i<d.length; i++) d[i]=Math.random()*2-1;
            whiteNoiseSource = audioCtx.createBufferSource(); whiteNoiseSource.buffer=b; whiteNoiseSource.loop=true;
            const g = audioCtx.createGain(); g.gain.value=0.1;
            whiteNoiseSource.connect(g); g.connect(audioCtx.destination); whiteNoiseSource.start();
        }
        function stopWhiteNoise() { if(whiteNoiseSource){ whiteNoiseSource.stop(); whiteNoiseSource=null; } }

        let resetInt;
        window.activateReset = function() {
            document.getElementById('resetOverlay').style.display = 'flex';
            try { playWhiteNoise(); } catch(e){}
            let t=30; document.getElementById('resetCount').innerText=t;
            resetInt = setInterval(()=>{ t--; document.getElementById('resetCount').innerText=t; if(t<=0) closeReset(); }, 1000);
        }
        window.closeReset = function() {
            clearInterval(resetInt); document.getElementById('resetOverlay').style.display='none'; stopWhiteNoise();
            addMessage("M·ª´ng c·∫≠u quay l·∫°i! üåø", 'ai');
        }

        // Map & Helpers
        function renderClassMap() {
            const g = document.getElementById('classMapGrid'); g.innerHTML='';
            for(let i=0; i<19; i++) {
                let d=document.createElement('div'); d.className='dot'; d.style.background=['#00b894','#ff7675','#74b9ff','#dfe6e9'][Math.floor(Math.random()*4)];
                g.appendChild(d);
            }
            let me=document.createElement('div'); me.className='dot'; me.id='myMapDot'; me.style.border='2px solid #333'; me.innerText='ME';
            g.insertBefore(me, g.firstChild);
        }
        function addMessage(html, type) {
            const b = document.getElementById('chatBox'); const d=document.createElement('div'); d.className=`msg ${type}`; d.innerHTML=html;
            b.appendChild(d); b.scrollTop=b.scrollHeight;
        }
        window.toggleModal = function(id) {
            document.getElementById(id).classList.toggle('active');
            if(id==='statsModal') document.getElementById('timelineContent').innerHTML=emotionLog.map(h=>`<div><small>${h.time}</small><br><b>B·∫°n:</b> ${h.user}<br><b>AI:</b> ${h.ai.substring(0,40)}...</div>`).join('<hr>');
        }
        window.startExercise = function(t) {
            toggleModal('therapyModal');
            let msg = (t==='breath')?"üå¨Ô∏è <b>H√≠t th·ªü:</b> H√≠t 4s - Gi·ªØ 7s - Th·ªü 8s.":(t==='stretch'?"üôÜ <b>C·ªï vai:</b> Nghi√™ng tr√°i ph·∫£i 10s.":"üëÅÔ∏è <b>5-4-3-2-1:</b> T√¨m 5 v·∫≠t nh√¨n th·∫•y.");
            addMessage(msg, 'ai');
        }

        document.getElementById('userInput').addEventListener("keypress", e=>{if(e.key==="Enter") handleChat()});
    </script>
</body>
</html>