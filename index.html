<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmoMap</title>
    <style>
        /* --- 1. GIAO DI·ªÜN G·ªêC (GI·ªÆ NGUY√äN) --- */
        :root { --primary: #ff9f43; --bg-color: #fff0e6; --chat-ai: #ffffff; }
        body.theme-sad { --primary: #74b9ff; --bg-color: #f1f7ff; }
        body.theme-stress { --primary: #ff7675; --bg-color: #fff0f0; }
        body.theme-happy { --primary: #00b894; --bg-color: #e6fffa; }
        body.theme-anxious { --primary: #a29bfe; --bg-color: #f8f0ff; }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }

        /* CONTAINER */
        .app-container { width: 100%; max-width: 450px; height: 95vh; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; overflow: hidden; border: 2px solid var(--primary); transition: 0.3s; }

        /* C∆† CH·∫æ CHUY·ªÇN M√ÄN H√åNH (FIX L·ªñI TR·∫ÆNG) */
        .screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 10; 
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n h·∫øt */
            flex-direction: column; 
            overflow-y: auto;
        }
        .screen.active { display: flex; animation: fadeIn 0.5s; } /* Ch·ªâ hi·ªán c√°i n√†o c√≥ class active */

        /* INTRO UI */
        .intro-content { padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        .intro-card { background: white; padding: 30px; border-radius: 20px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-top: 5px solid var(--primary); }
        .intro-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; outline: none; }
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; transition: 0.2s; }
        .btn:hover { transform: translateY(-2px); }

        /* SURVEY UI */
        .survey-content { padding: 20px; padding-bottom: 80px; }
        .survey-title { color: var(--primary); font-size: 1.4rem; font-weight: bold; text-align: center; margin-bottom: 10px; }
        .question-block { margin-bottom: 15px; background: #fdfdfd; padding: 15px; border-radius: 15px; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .q-text { font-weight: 600; margin-bottom: 10px; display: block; font-size: 0.95rem; color: #333; }
        .emoji-scale { display: flex; justify-content: space-between; padding: 0 5px; }
        .emoji-opt { cursor: pointer; font-size: 1.6rem; opacity: 0.4; transition: 0.2s; }
        .emoji-opt:hover { opacity: 0.8; transform: scale(1.1); }
        .emoji-opt.selected { opacity: 1; transform: scale(1.3); filter: drop-shadow(0 0 5px rgba(0,0,0,0.2)); }

        /* CHAT UI */
        .header { padding: 15px; background: var(--primary); color: white; display: flex; align-items: center; justify-content: space-between; z-index: 20; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .avatar-wrapper { width: 45px; height: 45px; }
        .kitty-svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2)); }
        
        .chat-area { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; background: rgba(255,255,255,0.5); }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; animation: fadeUp 0.3s ease; word-wrap: break-word; }
        .msg.ai { align-self: flex-start; background: var(--chat-ai); color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 4px; }

        .input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 25px; outline: none; }
        .send-btn { padding: 0 20px; background: var(--primary); border: none; border-radius: 25px; color: white; cursor: pointer; }

        /* TOOLS & MODALS */
        .tools-bar { display: flex; justify-content: space-around; padding: 10px; background: #fafafa; border-top: 1px solid #eee; }
        .tool-btn { font-size: 0.7rem; background: none; color: #666; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .tool-btn i { font-size: 1.1rem; }
        
        .float-reset { position: absolute; bottom: 140px; right: 15px; width: 45px; height: 45px; background: white; border: 2px solid var(--primary); border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 50; transition: 0.3s; }
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; flex-direction: column; padding: 20px; animation: slideUp 0.4s; }
        .modal.active { display: flex; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; font-weight: bold; color: var(--primary); font-size: 1.2rem; }
        
        .therapy-item { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
        .therapy-btn-mini { background: var(--primary); color: white; border: none; padding: 5px 15px; border-radius: 15px; margin-top: 5px; cursor: pointer; font-size: 0.8rem; }
        
        .typing { display: none; gap: 5px; padding: 10px; margin-left: 10px; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: blink 1.4s infinite both; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }

        #resetOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #a8e6cf, #dcedc1); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; color: #2d3436; }
        .reset-circle { width: 160px; height: 160px; border: 5px solid white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; color: white; animation: breathe 8s infinite; }
        .map-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .dot-map { width: 35px; height: 35px; border-radius: 50%; background: #eee; display: flex; justify-content: center; align-items: center; font-size: 0.6rem; color: white; font-weight: bold; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes breathe { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        @keyframes blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <div class="app-container">
        
        <div id="screen-intro" class="screen active">
            <div class="intro-content">
                <div class="intro-card">
                    <h1 style="color:var(--primary)">EmoMap AI üéß</h1>
                    <input type="text" id="inputName" class="intro-input" placeholder="T√™n c·ªßa b·∫°n..." required>
                    <input type="text" id="inputClass" class="intro-input" placeholder="L·ªõp (VD: 10A1)...">
                    <select id="inputGender" class="intro-input">
                        <option value="" disabled selected>-- Gi·ªõi t√≠nh --</option>
                        <option value="Nam">Nam</option>
                        <option value="N·ªØ">N·ªØ</option>
                    </select>
                    <button class="btn" onclick="goToSurvey()">V√†o Kh·∫£o S√°t</button>
                </div>
            </div>
        </div>

        <div id="screen-survey" class="screen">
            <div class="survey-content">
                <div class="survey-title">üìù G√≥c Chia S·∫ª</div>
                <p style="text-align:center; color:#666; font-size:0.9rem; margin-bottom:20px;">Ch·ªçn bi·ªÉu t∆∞·ª£ng ƒë√∫ng nh·∫•t v·ªõi b·∫°n</p>
                <div id="surveyQuestions"></div>
                <button class="btn" onclick="submitSurvey()">Ho√†n th√†nh & Chat</button>
            </div>
        </div>

        <div id="screen-chat" class="screen" style="padding:0; overflow:hidden;">
            <div class="header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div class="avatar-wrapper">
                        <svg class="kitty-svg" viewBox="0 0 512 512">
                            <path fill="#fff" d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0z"/>
                            <path fill="#333" d="M368 152a24 24 0 1 1 0 48 24 24 0 1 1 0-48zM144 152a24 24 0 1 1 0 48 24 24 0 1 1 0-48z"/>
                            <path fill="#e55039" d="M256 270c-10 0-18 5-18 12s8 12 18 12s18-5 18-12s-8-12-18-12z"/>
                            <path fill="#ff9f43" d="M376.6 96c-13.7-13.7-32-21.4-51.7-21.4H187.1c-19.7 0-38 7.7-51.7 21.4C122.1 110.1 114.6 128.4 114.6 148.1V176c0 8.8 7.2 16 16 16h256c8.8 0 16-7.2 16-16v-27.9c0-19.7-7.5-38-21.4-51.7z"/>
                        </svg>
                    </div>
                    <div>
                        <div style="font-weight: bold;">Kitty AI</div>
                        <div style="font-size: 0.7rem; opacity: 0.9;" id="statusText">ƒêang k·∫øt n·ªëi...</div>
                    </div>
                </div>
                <div class="mhi-score"><span id="mhiScore">75</span>/100</div>
            </div>

            <div class="chat-area" id="chatBox"></div>
            <div class="typing" id="typingIndicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
            <div class="float-reset" onclick="activateReset()" title="Reset T√¢m Tr√≠"><i class="fas fa-redo"></i></div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="Nh·∫Øn tin v·ªõi AI..." autocomplete="off">
                <button class="send-btn" onclick="handleChat()">G·ª≠i</button>
            </div>

            <div class="tools-bar">
                <button class="tool-btn" onclick="toggleModal('statsModal')"><i class="fas fa-chart-line"></i> Th·ªëng k√™</button>
                <button class="tool-btn" onclick="toggleModal('therapyModal')"><i class="fas fa-heartbeat"></i> Tr·ªã li·ªáu</button>
                <button class="tool-btn" onclick="toggleModal('mapModal')"><i class="fas fa-users"></i> L·ªõp h·ªçc</button>
            </div>
        </div>

        <div class="modal" id="statsModal">
            <div class="modal-header"><span>üìÖ Nh·∫≠t K√Ω</span><button class="close-btn" onclick="toggleModal('statsModal')">√ó</button></div>
            <div id="timelineContent"></div>
        </div>
        <div class="modal" id="mapModal">
            <div class="modal-header"><span>üó∫Ô∏è L·ªõp <span id="classTitle"></span></span><button class="close-btn" onclick="toggleModal('mapModal')">√ó</button></div>
            <div class="map-grid" id="classMapGrid"></div>
        </div>
        <div class="modal" id="therapyModal">
            <div class="modal-header"><span>üíä Tr·ªã Li·ªáu</span><button class="close-btn" onclick="toggleModal('therapyModal')">√ó</button></div>
            <div class="therapy-item"><b><i class="fas fa-wind"></i> H√≠t th·ªü 4-7-8</b><button class="therapy-btn-mini" onclick="startExercise('breath')">T·∫≠p ngay</button></div>
            <div class="therapy-item"><b><i class="fas fa-child"></i> Du·ªói c·ªï vai</b><button class="therapy-btn-mini" onclick="startExercise('stretch')">T·∫≠p ngay</button></div>
            <div class="therapy-item"><b><i class="fas fa-hand-holding"></i> Grounding</b><button class="therapy-btn-mini" onclick="startExercise('grounding')">T·∫≠p ngay</button></div>
        </div>
        <div id="resetOverlay">
            <h2>Th∆∞ gi√£n s√¢u...</h2>
            <div class="reset-circle" id="resetCount">30</div>
            <p>Ti·∫øng ·ªìn tr·∫Øng (White Noise)</p>
            <button onclick="closeReset()" style="margin-top:30px; padding:10px 30px; border-radius:20px; border:none; font-weight:bold;">ƒê√£ ·ªïn h∆°n</button>
        </div>

    </div>

    <script>
        // ============================================================
        // ‚ö†Ô∏è D√ÅN KEY GROQ V√ÄO ƒê√ÇY (GI·ªÆ NGO·∫∂C K√âP) ‚ö†Ô∏è
        const API_KEY = "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"; 
        // ============================================================

        const questions = [
            "M√¨nh c·∫£m th·∫•y an to√†n khi ·ªü tr∆∞·ªùng h·ªçc.",
            "M√¨nh t·ª´ng b·ªã ai ƒë√≥ ƒë√°nh, x√¥ ƒë·∫©y ho·∫∑c l√†m ƒëau ·ªü tr∆∞·ªùng.",
            "M√¨nh b·ªã b·∫°n b√® n√≥i x·∫•u, g√°n gh√©p bi·ªát danh.",
            "M√¨nh c·∫£m th·∫•y b·ªã c√¥ l·∫≠p, kh√¥ng ai ch∆°i c√πng.",
            "M√¨nh b·ªã nh·∫Øn tin ƒëe d·ªça tr√™n m·∫°ng x√£ h·ªôi.",
            "M√¨nh c·∫£m th·∫•y lo l·∫Øng m·ªói khi ph·∫£i ƒë·∫øn l·ªõp.",
            "M√¨nh ƒë√£ t·ª´ng ch·ª©ng ki·∫øn b·∫°n kh√°c b·ªã b·∫Øt n·∫°t.",
            "M√¨nh c√≥ th·∫ßy c√¥ ƒë·ªÉ chia s·∫ª khi g·∫∑p chuy·ªán.",
            "M√¨nh c·∫£m th·∫•y √°p l·ª±c ph·∫£i l√†m theo √Ω nh√≥m b·∫°n.",
            "M√¨nh tin r·∫±ng nh√† tr∆∞·ªùng s·∫Ω b·∫£o v·ªá m√¨nh."
        ];
        const emojis = [ {i:"üò†",v:1}, {i:"üòû",v:2}, {i:"üòê",v:3}, {i:"üôÇ",v:4}, {i:"ü§©",v:5} ];

        let messages = []; 
        let mhiScore = 75;
        let userProfile = {};
        let surveyResults = new Array(questions.length).fill(0);
        let history = JSON.parse(localStorage.getItem('emotionHistory')) || [];
        let audioCtx, whiteNoiseSource;

        // --- NAVIGATION ---
        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // 1. INTRO -> SURVEY
        window.goToSurvey = function() {
            const name = document.getElementById('inputName').value.trim();
            const gender = document.getElementById('inputGender').value;
            const className = document.getElementById('inputClass').value.trim();

            if(!name || !gender) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");
            if(!API_KEY || API_KEY.includes("D√ÅN_KEY")) return alert("L·ªñI: Ch∆∞a d√°n API Key Groq!");

            userProfile = { name, gender, class: className };
            switchScreen('screen-survey');

            document.getElementById('surveyQuestions').innerHTML = questions.map((q, idx) => `
                <div class="question-block">
                    <label class="q-text">${idx+1}. ${q}</label>
                    <div class="emoji-scale" id="q${idx}">
                        ${emojis.map(e => `<div class="emoji-opt" onclick="selectEmoji(${idx}, ${e.v}, this)">${e.i}</div>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        window.selectEmoji = function(qIdx, val, el) {
            const parent = document.getElementById(`q${qIdx}`);
            Array.from(parent.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            surveyResults[qIdx] = val;
        }

        // 2. SURVEY -> CHAT (FIX L·ªñI TR·∫ÆNG M√ÄN H√åNH)
        window.submitSurvey = async function() {
            if(surveyResults.includes(0)) return alert("H√£y tr·∫£ l·ªùi h·∫øt 10 c√¢u h·ªèi nh√©!");

            // CHUY·ªÇN M√ÄN H√åNH TR∆Ø·ªöC (ƒê·ªÉ kh√¥ng b·ªã tr·∫Øng)
            switchScreen('screen-chat');
            document.getElementById('classTitle').innerText = userProfile.class || "·∫¢o";
            renderClassMap();
            
            // SAU ƒê√ì M·ªöI G·ªåI AI
            let surveyText = questions.map((q, i) => `- ${q}: ${surveyResults[i]}/5`).join('\n');
            const systemPrompt = `B·∫°n l√† Kitty AI, chuy√™n gia t√¢m l√Ω h·ªçc ƒë∆∞·ªùng.
            User: ${userProfile.name}, ${userProfile.gender}, l·ªõp ${userProfile.class}.
            User v·ª´a l√†m kh·∫£o s√°t B·∫°o l·ª±c h·ªçc ƒë∆∞·ªùng:
            ${surveyText}
            NHI·ªÜM V·ª§:
            1. Ngay tin ƒë·∫ßu ti√™n: PH√ÇN T√çCH k·∫øt qu·∫£ n√†y.
               - N·∫øu ƒëi·ªÉm 4,5 ·ªü c√¢u ti√™u c·ª±c (b·ªã ƒë√°nh, n√≥i x·∫•u...) -> AN ·ª¶I ngay, h·ªèi "C·∫≠u c√≥ mu·ªën nghe nh·∫°c Lofi kh√¥ng?".
               - N·∫øu ·ªïn -> Ch√∫c m·ª´ng.
            2. N·∫øu user ƒë·ªìng √Ω nghe nh·∫°c: CH·ªà TR·∫¢ L·ªúI: "PLAY_SPOTIFY_NOW".
            3. Ng·∫Øn g·ªçn, ·∫•m √°p.`;

            messages.push({ role: "system", content: systemPrompt });
            messages.push({ role: "assistant", content: `Ch√†o ${userProfile.name}! M√¨nh ƒëang ƒë·ªçc k·∫øt qu·∫£ kh·∫£o s√°t c·ªßa c·∫≠u...` });

            document.getElementById('typingIndicator').style.display = 'flex';
            
            try {
                const response = await callGroqAPI(messages);
                document.getElementById('typingIndicator').style.display = 'none';
                document.getElementById('statusText').innerText = "Groq AI Online ‚ö°";
                processAIResponse(response);
                messages.push({ role: "assistant", content: response });
            } catch (e) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage(`‚ö†Ô∏è L·ªói Groq: ${e.message}`, 'ai');
            }
        }

        // 3. CHAT LOGIC
        async function handleChat() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text) return;

            addMessage(text, 'user');
            input.value = '';
            document.getElementById('typingIndicator').style.display = 'flex';
            
            messages.push({ role: "user", content: text });

            try {
                const aiText = await callGroqAPI(messages);
                document.getElementById('typingIndicator').style.display = 'none';
                messages.push({ role: "assistant", content: aiText });
                processAIResponse(aiText);
                saveHistory(text, aiText);
            } catch (error) {
                document.getElementById('typingIndicator').style.display = 'none';
                addMessage(`‚ö†Ô∏è L·ªói k·∫øt n·ªëi: ${error.message}`, 'ai');
            }
        }

        async function callGroqAPI(msgs) {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "llama-3.3-70b-versatile", messages: msgs, temperature: 0.7 })
            });
            if (!response.ok) throw new Error((await response.json()).error.message);
            return (await response.json()).choices[0].message.content;
        }

        function processAIResponse(text) {
            if (text.includes("PLAY_SPOTIFY_NOW")) {
                addMessage("Oki! B·∫≠t nh·∫°c chill ngay ƒë√¢y. üé∂", 'ai');
                const spotifyLink = "https://open.spotify.com/embed/playlist/37i9dQZF1DX0Caja87h9dO?utm_source=generator";
                addMessage(`<iframe style="border-radius:12px; margin-top:10px;" src="${spotifyLink}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`, 'ai');
            } else {
                addMessage(text.replace(/\*\*/g, ''), 'ai');
            }
            const t = text.toLowerCase();
            if(t.includes('bu·ªìn')||t.includes('kh√≥c')) changeTheme('sad');
            else if(t.includes('vui')||t.includes('tuy·ªát')) changeTheme('happy');
            else if(t.includes('cƒÉng')||t.includes('lo')) changeTheme('stress');
        }

        // --- EXTRAS ---
        function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        function playWhiteNoise() {
            initAudio();
            const b = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
            const d = b.getChannelData(0); for(let i=0; i<d.length; i++) d[i]=Math.random()*2-1;
            whiteNoiseSource = audioCtx.createBufferSource(); whiteNoiseSource.buffer=b; whiteNoiseSource.loop=true;
            const g = audioCtx.createGain(); g.gain.value=0.1;
            whiteNoiseSource.connect(g); g.connect(audioCtx.destination); whiteNoiseSource.start();
        }
        function stopWhiteNoise() { if(whiteNoiseSource){ whiteNoiseSource.stop(); whiteNoiseSource=null; } }

        let resetInt;
        window.activateReset = function() {
            document.getElementById('resetOverlay').style.display = 'flex';
            try { playWhiteNoise(); } catch(e){}
            let t=30; document.getElementById('resetCount').innerText=t;
            resetInt = setInterval(()=>{ t--; document.getElementById('resetCount').innerText=t; if(t<=0) closeReset(); }, 1000);
        }
        window.closeReset = function() {
            clearInterval(resetInt); document.getElementById('resetOverlay').style.display='none'; stopWhiteNoise();
            addMessage("M·ª´ng c·∫≠u quay l·∫°i! üåø", 'ai');
        }

        function renderClassMap() {
            const g = document.getElementById('classMapGrid'); g.innerHTML='';
            for(let i=0; i<19; i++) {
                let d=document.createElement('div'); d.className='dot-map'; d.style.background=['#00b894','#ff7675','#74b9ff','#dfe6e9'][Math.floor(Math.random()*4)];
                g.appendChild(d);
            }
            let me=document.createElement('div'); me.className='dot-map'; me.id='myMapDot'; me.style.border='2px solid #333'; me.innerText='ME';
            g.insertBefore(me, g.firstChild);
        }
        function addMessage(html, type) {
            const b = document.getElementById('chatBox'); const d=document.createElement('div'); d.className=`msg ${type}`; d.innerHTML=html;
            b.appendChild(d); b.scrollTop=b.scrollHeight;
        }
        window.toggleModal = function(id) {
            const m = document.getElementById(id); m.classList.toggle('active');
            if(id==='statsModal' && m.classList.contains('active')) document.getElementById('timelineContent').innerHTML = history.map(h => `<div><small>${h.time}</small><br><b>B·∫°n:</b> ${h.user}<br><b>AI:</b> ${h.ai.substring(0,40)}...</div>`).join('<hr>');
        }
        window.startExercise = function(t) {
            document.getElementById('therapyModal').classList.remove('active');
            let msg = (t==='breath')?"üå¨Ô∏è <b>H√≠t th·ªü:</b> H√≠t 4s - Gi·ªØ 7s - Th·ªü 8s.":(t==='stretch'?"üôÜ <b>C·ªï vai:</b> Nghi√™ng tr√°i ph·∫£i 10s.":"üëÅÔ∏è <b>5-4-3-2-1:</b> T√¨m 5 v·∫≠t nh√¨n th·∫•y.");
            addMessage(msg, 'ai');
        }
        function changeTheme(e) { document.body.className = ''; if(e) document.body.classList.add(`theme-${e}`); }
        function saveHistory(u, a) { history.unshift({ time: new Date().toLocaleTimeString(), user: u, ai: a }); localStorage.setItem('emotionHistory', JSON.stringify(history)); }

        document.getElementById('userInput').addEventListener("keypress", e=>{if(e.key==="Enter") handleChat()});
    </script>
</body>
</html>
